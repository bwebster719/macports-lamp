#!/bin/bash

# Remove startup items; these will be replaced.
if [ -e /Library/LaunchDaemons/org.macports.mysql55-server.plist ]; then
  rm /Library/LaunchDaemons/org.macports.mysql55-server.plist
fi
if [ -e /Library/LaunchDaemons/org.macports.mysql57-server.plist ]; then
  rm /Library/LaunchDaemons/org.macports.mysql57-server.plist
fi
if [ -e /Library/LaunchDaemons/org.macports.mariadb-server.plist ]; then
  rm /Library/LaunchDaemons/org.macports.mariadb-server.plist 
fi

# Start with MySQL server. The -N flag loads defaults instead of prompting.
port -N install mysql57-server

if [ -e /opt/local/etc/mysql57/my.cnf ]; then
  mv /opt/local/etc/mysql57/my.cnf /opt/local/etc/mysql57/my.cnf.disabled
  echo "Disabled my.cnf in /opt/local/etc/mysql55/my.cnf; please use /etc/my.cnf"
fi

DATESTRING=`date +"%y%m%d%H%M"`
if [ -e /etc/my.cnf ]; then
  mv /etc/my.cnf /etc/my.cnf.$DATESTRING
  echo "Backed up /etc/my.cnf to /etc/my.cnf.$DATESTRING"
fi
if [ ! -e ./my.cnf ]; then
  echo "Could not find my.cnf source."
  if [ "${PWD##*/}" != "macports-lamp" ]; then
    echo "Please cd into macports-lamp directory before running."
    exit 1
  fi
else
  cp ./my.cnf /etc/my.cnf
fi

# Create initial databases.
sudo /opt/local/lib/mysql57/bin/mysqld --initialize --user=_mysql

# Map mysql command-line binaries to the version we are installing.
# Horrible workaround, see https://trac.macports.org/ticket/60275
touch /opt/local/share/man/mysql57/man1/mysql-stress-test.pl.1.gz
touch /opt/local/share/man/mysql57/man1/mysql-test-run.pl.1.gz
touch /opt/local/share/man/mysql57/man1/mysql_client_test.1.gz
touch /opt/local/share/man/mysql57/man1/mysql_client_test_embedded.1.gz
touch /opt/local/share/man/mysql57/man1/mysqltest.1.gz
touch /opt/local/share/man/mysql57/man1/mysqltest_embedded.1.gz

port select mysql mysql57

# Port install may have loaded already.
port unload mysql57-server > /dev/null 2>&1

# Start MySQL.
port -d load mysql57-server

echo
echo

echo "Please enter the root password you'd like to use for MySQL:"
read -s ROOTPW

echo
echo "Your Mac sudo password may be needed"
# Make it possible to view MySQL error log without sudo
sudo chgrp staff /opt/local/var/log/mysql57/error.log
# Parse autogenerated password from startup log.
MY57P=$(sudo grep 'temporary password' /opt/local/var/log/mysql57/error.log | tail -1 | awk '{ print $11 }')

/opt/local/lib/mysql57/bin/mysql --connect-expired-password -uroot -p"${MY57P}" -e "ALTER USER root@localhost IDENTIFIED BY '${ROOTPW}'"

/opt/local/lib/mysql57/bin/mysql -uroot -p"${ROOTPW}" -e "DROP DATABASE IF EXISTS test;
  DELETE FROM mysql.user WHERE User='';
  DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
  DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
  FLUSH PRIVILEGES;"


# Warn on old path to mariadb binaries.
grep -qF '^PATH=$PATH:/opt/local/lib/mariadb/bin' ~/.bash_profile || echo; echo 'WARNING: you should comment out the following deprecated line in your .bash_profile: PATH=$PATH:/opt/local/lib/mariadb/bin'; echo

echo "MySQL 5.7 will launch automatically at startup. If you don't want this type:"
echo "sudo launchctl unload -w /Library/LaunchDaemons/org.macports.mysql57-server.plist"
echo 
echo "And if you change your mind and want to load it at startup again, type:"
echo "sudo launchctl load -w /Library/LaunchDaemons/org.macports.mysql57-server.plist"
echo
echo "-----"
echo "If you cannot get into MySQL you can reset the root password by"
echo "starting it manually:"
echo
echo "sudo -u _mysql /opt/local/lib/mysql57/bin/mysqld --user=_mysql --skip-grant-tables"
echo
echo "Then type mysql at the command line and set the root password:"
echo
echo "USE mysql;"
echo "UPDATE user SET password=PASSWORD('foo') WHERE User='root';"
echo "FLUSH PRIVILEGES;"
echo "-----"
echo
echo "MySQL connections are available through the following local socket:"
echo "/opt/local/var/run/mysql57/mysqld.sock"
echo
